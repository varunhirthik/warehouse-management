<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Warehouse Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cafe-brown': '#8B4513',
                        'cafe-cream': '#F5F5DC',
                        'cafe-gold': '#DAA520',
                    }
                }
            }
        }
    </script>
    
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-flash {
            animation: successFlash 0.5s ease-in-out;
        }
        
        @keyframes successFlash {
            0% { background-color: #10B981; }
            100% { background-color: #059669; }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8B4513;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-cafe-cream min-h-screen">
    <!-- Header -->
    <header class="bg-cafe-brown text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-coffee text-2xl text-cafe-gold"></i>
                    <h1 class="text-2xl font-bold">Cafe Manager</h1>
                </div>
                <div class="text-right">
                    <p class="text-sm opacity-80">Total Profit</p>
                    <p id="total-profit" class="text-xl font-bold text-cafe-gold">₹0.00</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-cafe-brown font-medium">Processing...</span>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="fixed top-20 left-4 right-4 z-40"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <div id="departments-container" class="space-y-6">
            <!-- Department cards will be populated here -->
        </div>
    </main>

    <!-- Add Stock Modal -->
    <div id="add-stock-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-cafe-brown">
                    <i class="fas fa-plus-circle mr-2"></i>Add Stock
                </h3>
                <button onclick="closeAddStockModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-stock-form" class="space-y-4">
                <input type="hidden" id="add-department-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                    <select id="add-product-select" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cafe-brown focus:border-transparent">
                        <option value="">Select a product...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="add-quantity" min="1" step="1" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cafe-brown focus:border-transparent"
                           placeholder="Enter quantity to add">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeAddStockModal()" 
                            class="flex-1 py-3 px-4 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 px-4 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>Add Stock
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Sale Modal -->
    <div id="record-sale-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-cafe-brown">
                    <i class="fas fa-cash-register mr-2"></i>Record Sale
                </h3>
                <button onclick="closeRecordSaleModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="record-sale-form" class="space-y-4">
                <input type="hidden" id="sale-department-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                    <select id="sale-product-select" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cafe-brown focus:border-transparent" onchange="updateSaleProductInfo()">
                        <option value="">Select a product...</option>
                    </select>
                </div>
                
                <div id="product-info" class="hidden bg-blue-50 p-3 rounded-lg border">
                    <p class="text-sm text-gray-600">Available Stock: <span id="available-stock" class="font-bold"></span></p>
                    <p class="text-sm text-gray-600">Cost Price: ₹<span id="cost-price" class="font-bold"></span></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity Sold</label>
                    <input type="number" id="sale-quantity" min="1" step="1" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cafe-brown focus:border-transparent"
                           placeholder="Enter quantity sold">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price (per unit)</label>
                    <input type="number" id="sale-price" min="0" step="0.01" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cafe-brown focus:border-transparent"
                           placeholder="Enter selling price per unit">
                </div>
                
                <div id="profit-preview" class="hidden bg-green-50 p-3 rounded-lg border">
                    <p class="text-sm text-green-700">Expected Profit: ₹<span id="expected-profit" class="font-bold"></span></p>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeRecordSaleModal()" 
                            class="flex-1 py-3 px-4 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 px-4 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition">
                        <i class="fas fa-cash-register mr-2"></i>Record Sale
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardData = {};
        let currentDepartmentProducts = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndDisplayDashboard();
        });

        // Fetch dashboard data and update UI
        async function fetchAndDisplayDashboard() {
            try {
                showLoading(true);
                const response = await fetch('/dashboard');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                dashboardData = await response.json();
                updateDashboardUI();
                showMessage('Dashboard updated successfully!', 'success');
            } catch (error) {
                console.error('Error fetching dashboard:', error);
                showMessage('Failed to load dashboard data. Please refresh the page.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update the dashboard UI with fetched data
        function updateDashboardUI() {
            // Update total profit
            document.getElementById('total-profit').textContent = `₹${dashboardData.overall_profit}`;
            
            // Clear and populate departments
            const container = document.getElementById('departments-container');
            container.innerHTML = '';
            
            dashboardData.departments.forEach(department => {
                const departmentCard = createDepartmentCard(department);
                container.appendChild(departmentCard);
            });
        }

        // Create department card HTML
        function createDepartmentCard(department) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden fade-in';
            
            let productsHTML = '';
            if (department.products.length === 0) {
                productsHTML = '<p class="text-gray-500 text-center py-4">No products with inventory or sales yet</p>';
            } else {
                productsHTML = department.products.map(product => `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">${product.name}</h4>
                            <p class="text-sm text-gray-500">Cost: ₹${product.cost_price}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${product.current_stock < 5 ? 'text-red-600' : 'text-green-600'}">
                                Stock: ${product.current_stock}
                                ${product.current_stock < 5 ? '<i class="fas fa-exclamation-triangle ml-1"></i>' : ''}
                            </p>
                            <p class="text-sm text-blue-600">Profit: ₹${product.total_profit}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            card.innerHTML = `
                <div class="bg-gradient-to-r from-cafe-brown to-cafe-gold p-4">
                    <div class="flex items-center justify-between text-white">
                        <div>
                            <h2 class="text-xl font-bold">${department.name}</h2>
                            <p class="text-cafe-cream opacity-90">Department Profit: ₹${department.total_department_profit}</p>
                        </div>
                        <div class="text-right">
                            <i class="fas ${department.name.includes('Beverages') ? 'fa-coffee' : 'fa-utensils'} text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <div class="mb-4">
                        ${productsHTML}
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="openAddStockModal(${department.id}, '${department.name}')" 
                                class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition shadow-md">
                            <i class="fas fa-plus mr-2"></i>Add Stock
                        </button>
                        <button onclick="openRecordSaleModal(${department.id}, '${department.name}')" 
                                class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-red-700 transition shadow-md">
                            <i class="fas fa-cash-register mr-2"></i>Record Sale
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Open Add Stock Modal
        async function openAddStockModal(departmentId, departmentName) {
            try {
                showLoading(true);
                const response = await fetch(`/products/${departmentId}`);
                const data = await response.json();
                
                currentDepartmentProducts = data.products;
                
                document.getElementById('add-department-id').value = departmentId;
                const select = document.getElementById('add-product-select');
                select.innerHTML = '<option value="">Select a product...</option>';
                
                data.products.forEach(product => {
                    select.innerHTML += `<option value="${product.id}" data-cost="${product.cost_price}">${product.name} (₹${product.cost_price})</option>`;
                });
                
                document.getElementById('add-stock-modal').classList.remove('hidden');
            } catch (error) {
                showMessage('Failed to load products', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Close Add Stock Modal
        function closeAddStockModal() {
            document.getElementById('add-stock-modal').classList.add('hidden');
            document.getElementById('add-stock-form').reset();
        }

        // Open Record Sale Modal
        async function openRecordSaleModal(departmentId, departmentName) {
            try {
                showLoading(true);
                const response = await fetch(`/products/${departmentId}`);
                const data = await response.json();
                
                currentDepartmentProducts = data.products;
                
                document.getElementById('sale-department-id').value = departmentId;
                const select = document.getElementById('sale-product-select');
                select.innerHTML = '<option value="">Select a product...</option>';
                
                // Only show products with stock > 0
                data.products.filter(p => p.current_stock > 0).forEach(product => {
                    select.innerHTML += `<option value="${product.id}" data-cost="${product.cost_price}" data-stock="${product.current_stock}">${product.name} (Stock: ${product.current_stock})</option>`;
                });
                
                document.getElementById('record-sale-modal').classList.remove('hidden');
            } catch (error) {
                showMessage('Failed to load products', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Close Record Sale Modal
        function closeRecordSaleModal() {
            document.getElementById('record-sale-modal').classList.add('hidden');
            document.getElementById('record-sale-form').reset();
            document.getElementById('product-info').classList.add('hidden');
            document.getElementById('profit-preview').classList.add('hidden');
        }

        // Update sale product info when product is selected
        function updateSaleProductInfo() {
            const select = document.getElementById('sale-product-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const stock = selectedOption.getAttribute('data-stock');
                const cost = selectedOption.getAttribute('data-cost');
                
                document.getElementById('available-stock').textContent = stock;
                document.getElementById('cost-price').textContent = cost;
                document.getElementById('product-info').classList.remove('hidden');
                
                document.getElementById('sale-quantity').max = stock;
                
                // Update profit preview when quantity or price changes
                updateProfitPreview();
            } else {
                document.getElementById('product-info').classList.add('hidden');
                document.getElementById('profit-preview').classList.add('hidden');
            }
        }

        // Update profit preview
        function updateProfitPreview() {
            const select = document.getElementById('sale-product-select');
            const quantity = parseFloat(document.getElementById('sale-quantity').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('sale-price').value) || 0;
            
            if (select.value && quantity > 0 && sellingPrice > 0) {
                const selectedOption = select.options[select.selectedIndex];
                const costPrice = parseFloat(selectedOption.getAttribute('data-cost'));
                const profit = (sellingPrice - costPrice) * quantity;
                
                document.getElementById('expected-profit').textContent = profit.toFixed(2);
                document.getElementById('profit-preview').classList.remove('hidden');
            } else {
                document.getElementById('profit-preview').classList.add('hidden');
            }
        }

        // Add event listeners for profit preview
        document.getElementById('sale-quantity').addEventListener('input', updateProfitPreview);
        document.getElementById('sale-price').addEventListener('input', updateProfitPreview);

        // Handle Add Stock form submission
        document.getElementById('add-stock-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                product_id: parseInt(document.getElementById('add-product-select').value),
                department_id: parseInt(document.getElementById('add-department-id').value),
                quantity_change: parseInt(document.getElementById('add-quantity').value),
                type: 'import',
                selling_price: 0
            };
            
            try {
                showLoading(true);
                const response = await fetch('/log_transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`✅ Added ${formData.quantity_change} units of ${result.product}`, 'success');
                    closeAddStockModal();
                    await fetchAndDisplayDashboard();
                } else {
                    showMessage(`❌ ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('❌ Failed to add stock', 'error');
            } finally {
                showLoading(false);
            }
        });

        // Handle Record Sale form submission
        document.getElementById('record-sale-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const select = document.getElementById('sale-product-select');
            const maxStock = parseInt(select.options[select.selectedIndex].getAttribute('data-stock'));
            
            if (quantity > maxStock) {
                showMessage(`❌ Cannot sell ${quantity} units. Only ${maxStock} available.`, 'error');
                return;
            }
            
            const formData = {
                product_id: parseInt(document.getElementById('sale-product-select').value),
                department_id: parseInt(document.getElementById('sale-department-id').value),
                quantity_change: quantity,
                type: 'sale',
                selling_price: parseFloat(document.getElementById('sale-price').value)
            };
            
            try {
                showLoading(true);
                const response = await fetch('/log_transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const profit = (formData.selling_price - parseFloat(select.options[select.selectedIndex].getAttribute('data-cost'))) * quantity;
                    showMessage(`✅ Sold ${quantity} units of ${result.product}. Profit: ₹${profit.toFixed(2)}`, 'success');
                    closeRecordSaleModal();
                    await fetchAndDisplayDashboard();
                } else {
                    showMessage(`❌ ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('❌ Failed to record sale', 'error');
            } finally {
                showLoading(false);
            }
        });

        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            messageDiv.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-2 fade-in`;
            messageDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Auto-refresh dashboard every 30 seconds
        setInterval(fetchAndDisplayDashboard, 30000);
    </script>
</body>
</html>
